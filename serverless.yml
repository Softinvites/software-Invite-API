service: softinvites-backend

frameworkVersion: '3'

provider:
  name: aws
  # runtime: nodejs20.x
  runtime: nodejs18.x
  region: ${env:AWS_REGION, 'us-east-2'}
  stage: ${env:STAGE, 'dev'}
  architecture: arm64

  httpApi:
    cors:
      allowedOrigins:
        - ${env:FRONTEND_URL, 'https://www.softinvite.com'}
        - https://softinvite-scan.vercel.app
      allowedHeaders:
        - Content-Type
        - Authorization
        - X-Amz-Date
        - X-Api-Key
      allowedMethods:
        - OPTIONS
        - GET
        - POST
        - PUT
        - DELETE
      maxAge: 86400

  environment:
    MONGODB_URI: ${env:MONGODB_URI, 'mongodb+srv://softinvites:Pi1pZr1yjuIcJ5pL@cluster1.f69gx.mongodb.net/softinvites?retryWrites=true&w=majority'}
    JWT_SECRET: ${env:JWT_SECRET, 'soft_invites363effbch7ee'}
    S3_BUCKET: ${env:S3_BUCKET, 'softinvites-assets'}
    REGION: ${env:AWS_REGION, 'us-east-2'}
    CDN_URL: ${env:CDN_URL, 'https://softinvites-assets.s3.amazonaws.com'}
    QR_LAMBDA_FUNCTION_NAME: ${env:QR_LAMBDA_FUNCTION_NAME, 'generateQrToS3'}
    IMPORT_LAMBDA_FUNCTION_NAME: ${env:IMPORT_LAMBDA_FUNCTION_NAME, 'importGuestsLambda'}
    ZIP_LAMBDA_FUNCTION_NAME: ${env:ZIP_LAMBDA_FUNCTION_NAME, 'downloadZipLambdaFunction'}
    FRONTEND_URL: ${env:FRONTEND_URL, 'https://www.softinvite.com'}
    BACKUP_BUCKET: ${env:BACKUP_BUCKET, 'softinvites-backups'}
    BACKUP_LAMBDA: ${env:BACKUP_LAMBDA, 'softinvites-backend-dev-backup'}

  iam:
    role:
      statements:
        - Effect: Allow
          Action:
            - s3:*
            - lambda:InvokeFunction
          Resource: "*"

functions:
  app:
    handler: dist/index.handler
    layers:
      - arn:aws:lambda:us-east-2:402961397587:layer:sharp-layer:5
    events:
      - httpApi:
          method: ANY
          path: /{proxy+}   
    memorySize: 1024
    timeout: 100

  backup:
    handler: dist/backup.handler
    description: "Event-driven MongoDB backup to S3"
    memorySize: 512
    timeout: 120
    environment:
      MONGODB_URI: ${env:MONGODB_URI, 'mongodb+srv://softinvites:Pi1pZr1yjuIcJ5pL@cluster1.f69gx.mongodb.net/softinvites'}
      BACKUP_BUCKET: ${env:BACKUP_BUCKET, 'softinvites-backups'}

plugins:
  # - serverless-plugin-dotenv
  - serverless-offline
  - serverless-esbuild

package:
  patterns:
    - '!node_modules/.cache/**'
    - '!node_modules/**/*.md'
    - '!node_modules/lodash/fp/**'
    - '!.git/**'
    - '!.gitignore'
    - '!node_modules/sharp/**'
  individually: true

custom:
  dotenv:
    path: .env
  serverless-offline:
    httpPort: 4000
    lambdaPort: 3002
    noPrependStageInUrl: true
  esbuild:
    bundle: true
    minify: true
    sourcemap: false
    target: node20
    platform: node
    concurrency: 10
    external:
      - sharp