service: softinvites-backend
configValidationMode: error

# frameworkVersion: '3'

provider:
  name: aws
  # runtime: nodejs20.x
  runtime: nodejs18.x
  region: ${env:AWS_REGION, 'us-east-2'}
  apiGateway:
    binaryMediaTypes:
      - "image/png"
      - "image/jpeg"
      - "application/octet-stream"

  stage: ${env:STAGE, 'dev'}
  architecture: arm64

  httpApi:
    cors:
      allowedOrigins:
        - ${env:FRONTEND_URL, 'https://www.softinvite.com'}
        - https://softinvite.com
        - https://softinvite-scan.vercel.app
        - http://localhost:3039
      allowCredentials: true
      allowedHeaders:
        - Content-Type
        - Authorization
        - X-Amz-Date
        - X-Api-Key
      allowedMethods:
        - OPTIONS
        - GET
        - POST
        - PUT
        - DELETE
      maxAge: 86400

  environment:
    MONGODB_URI: ${env:MONGODB_URI, 'mongodb+srv://softinvites:Pi1pZr1yjuIcJ5pL@cluster1.f69gx.mongodb.net/softinvites?retryWrites=true&w=majority'}
    JWT_SECRET: ${env:JWT_SECRET, 'soft_invites363effbch7ee'}
    S3_BUCKET: ${env:S3_BUCKET, 'softinvites-assets'}
    REGION: ${env:AWS_REGION, 'us-east-2'}
    CDN_URL: ${env:CDN_URL, 'https://softinvites-assets.s3.amazonaws.com'}
    QR_LAMBDA_FUNCTION_NAME: ${env:QR_LAMBDA_FUNCTION_NAME, 'generateQrToS3'}
    IMPORT_LAMBDA_FUNCTION_NAME: ${env:IMPORT_LAMBDA_FUNCTION_NAME, 'importGuestsLambda'}
    ZIP_LAMBDA_FUNCTION_NAME: ${env:ZIP_LAMBDA_FUNCTION_NAME, 'downloadZipLambdaFunction'}
    EMAIL_LAMBDA_FUNCTION_NAME: ${env:EMAIL_LAMBDA_FUNCTION_NAME, 'sendEmailLambdaFunction'}
    FRONTEND_URL: ${env:FRONTEND_URL, 'https://www.softinvite.com'}
    BACKUP_BUCKET: ${env:BACKUP_BUCKET, 'softinvites-backups'}
    BACKUP_LAMBDA: ${env:BACKUP_LAMBDA, 'softinvites-backend-dev-backup'}
    EMAIL_FROM: ${env:EMAIL_FROM, 'info@softinvite.com'}
    SERVERLESS_LICENSE_KEY: ${env:SERVERLESS_LICENSE_KEY, 'eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJvcmdJZCI6IjdmYjQ0ZmY4LTQ5YmUtNGY0My1iMmM2LTliMzIyYmU5ZmQ3OSIsImlhdCI6MTc1NjM3MjU3NCwiZXhwIjoxNzg3OTA4NTc0LCJpc3MiOiJhcHAuc2VydmVybGVzcy5jb20ifQ.wxYOYIhN7zKm1zUY3l0RaHDnGOWKBqjdt9aPzjaiWZrMqhOxRWr8AD7Oy_-KQ-JnBu4ow1rKFqgFWc62EYwMY5XZvtCM91U-3lixSNMtqCyMhokEusEVM3IApNdQcl2fBS65RHGg1DVdWIVMGBBURMTDyy1DP0fhcINigjr08zP6iNeyjypdNp_az1TfDPZHVpAItKsIhk0sp0I9TBC_GPObgQ8gH9BK2guDNsEP92XJLoQaDCRXwlVemX3QjT3H6lEJBJjrzzAkOiDaGBd0TEHcpwbORdWKpZB9IRjmD0B6RVXU4W2azSGx8HEG3wHimraoUYXSG9Y9VOKEcpHq2w'}

  iam:
    role:
      statements:
        - Effect: Allow
          Action:
            - s3:*
            - lambda:InvokeFunction
          Resource: "*"

functions:
  app:
    handler: dist/index.handler
    layers:
      - arn:aws:lambda:us-east-2:402961397587:layer:Sharp:1
    events:
      - httpApi:
          method: ANY
          path: /{proxy+}   
    memorySize: 1024
    timeout: 30

  backup:
    handler: dist/backup.handler
    description: "Event-driven MongoDB backup to S3"
    memorySize: 512
    timeout: 120
    environment:
      MONGODB_URI: ${env:MONGODB_URI, 'mongodb+srv://softinvites:Pi1pZr1yjuIcJ5pL@cluster1.f69gx.mongodb.net/softinvites'}
      BACKUP_BUCKET: ${env:BACKUP_BUCKET, 'softinvites-backups'}

plugins:
  - serverless-plugin-dotenv
  - serverless-offline
  - serverless-esbuild

package:
  patterns:
    - '!node_modules/.cache/**'
    - '!node_modules/**/*.md'
    - '!node_modules/lodash/fp/**'
    - '!.git/**'
    - '!.gitignore'
    - '!node_modules/sharp/**'
  individually: true

custom:
  esbuild:
    bundle: true
  dotenv:
    path: .env
  serverless-offline:
    httpPort: 4000
    noPrependStageInUrl: true
  build:
    esbuild:
      bundle: true
      minify: true
      sourcemap: false
      target: node20
      platform: node
      concurrency: 10
      external:
        - sharp 